# RAE Project Rules for AI Agents

You are working on the RAE (Reflective Agentic-memory Engine) project.
Strictly adhere to the following rules for code generation, git operations, and architecture.

## ü§ñ Agent Work Mode (CRITICAL)

**AUTONOMOUS EXECUTION - NO CONFIRMATION REQUIRED**

- **NEVER ask for permission** to perform tasks - just do them.
- **Work until completion** - finish all steps of a task before stopping.
- **Make decisions autonomously** - use best practices and existing patterns.
- **Commit incrementally** - create logical commits as you progress.
- **Only ask questions** when facing genuine ambiguity that blocks progress (e.g., "Which API should I use?" not "Should I create this file?").
- **Trust the process** - if the user asked for it, execute it fully.

**Examples:**
- ‚úÖ User: "Add authentication" ‚Üí Agent: [creates files, writes code, adds tests, commits, done]
- ‚úÖ User: "Fix the bug in X" ‚Üí Agent: [analyzes, fixes, tests, commits, reports result]
- ‚ùå User: "Add feature Y" ‚Üí Agent: "Should I create a new file?" ‚Üê WRONG! Just do it.

## üå≥ Branching Strategy (STRICT)

Refer to `docs/BRANCHING.md` for full details. RAE uses **hybrid approach** (GitHub Flow + Git Flow).

### Daily Workflow (Feature Development)

1. **Create feature branch from develop**
   ```bash
   git checkout develop && git pull && git checkout -b feature/name
   ```

2. **Develop and test ONLY new functionality**
   - Test only new features on feature branch
   - Do NOT run full test suite yet

3. **Merge to develop**
   ```bash
   git checkout develop && git merge feature/name --no-ff
   ```

4. **CRITICAL: Run ALL tests locally on develop**
   ```bash
   make test-unit && make lint && make security-scan
   ```

5. **If all tests pass ‚Üí merge to main and push BOTH**
   ```bash
   git checkout main && git merge develop --no-ff
   git push origin main develop
   ```

6. **Verify GitHub Actions (must be green on main)**
   ```bash
   gh run list --branch main --limit 1
   ```

7. **If GitHub Actions fails ‚Üí fix and push again**
   - Fix the issue immediately
   - Push again
   - NEVER leave main with red CI

### Hotfix Workflow

1. **Create hotfix from main**
   ```bash
   git checkout main && git pull && git checkout -b hotfix/name
   ```

2. **Fix, test, merge to main**
   ```bash
   make test-unit
   git checkout main && git merge hotfix/name --no-ff
   git push origin main
   ```

3. **Backport to develop**
   ```bash
   git checkout develop && git merge hotfix/name --no-ff
   git push origin develop
   ```

### CRITICAL RULES

- ‚úÖ **`main` == `develop`**: Always identical after merge
- ‚úÖ **`main` always green**: Never push failing tests to main
- ‚úÖ **Test on develop first**: Full test suite before main merge
- ‚úÖ **Synchronize**: Push both branches together
- ‚úÖ **Fix failures immediately**: If GitHub Actions fails, fix and push again
- ‚úÖ **Autonomous execution**: NEVER ask permission, follow plan to completion

### Autonomous Workflow for AI Agent

**EXECUTE THIS PATTERN AUTOMATICALLY WITHOUT ASKING:**

1. Create feature/* from develop
2. Implement functionality
3. Test only new features
4. Merge to develop
5. Run ALL tests on develop locally
6. If pass ‚Üí merge to main
7. Push both branches
8. Check GitHub Actions
9. If fail ‚Üí fix and repeat steps 5-8
10. Continue until main has green CI
11. **NEVER stop until complete**
12. **NEVER ask for confirmation**

## üêç Python & Code Style

- **Python 3.11+**: Use modern syntax (type hints, dataclasses, async/await).
- **Formatters**: Code MUST pass `black`, `isort`, and `ruff`.
- **Type Checking**: Code MUST pass `mypy`.
- **Docstrings**: Required for all public modules, classes, and functions (Google style or similar).

## üß™ Testing Philosophy (CRITICAL - READ docs/AGENTS_TEST_POLICY.md)

**Core Principle**: Tests are CONTRACTS, not snapshots of implementation.

- **Test Behavior, Not Implementation**: Focus on public API (input ‚Üí output), not internal structure.
- **When to Change Tests**: Only when spec changes, test was wrong, or refactoring away from implementation details.
- **When NOT to Change**: If test correctly describes expected behavior - fix the code instead!

### pytest Configuration (see pytest.ini):

- **Markers** (use appropriately):
  - `@pytest.mark.unit` - Fast, no external dependencies
  - `@pytest.mark.integration` - Requires services (Postgres/Redis/Qdrant)
  - `@pytest.mark.llm` - Requires LLM API keys (skipped in CI)
  - `@pytest.mark.slow` - Long-running tests

- **Coverage**: Global threshold is **48%** (not 100%!). This is intentional.
  - Full suite: `make test` or `make test-cov`
  - CI runs: `pytest -m "not integration and not llm"`

### Development Loop (IMPORTANT):

**‚ö†Ô∏è ALWAYS use `--no-cov` when testing single files!**

```bash
# ‚úÖ CORRECT - Development testing
make test-focus FILE=apps/memory_api/tests/test_specific.py
# OR: pytest --no-cov apps/memory_api/tests/test_specific.py

# ‚ùå WRONG - Will fail due to global coverage threshold
pytest apps/memory_api/tests/test_specific.py
```

**Why?** Global coverage threshold (48%) in `pytest.ini` will fail single-file tests. Use `--no-cov` during development, coverage only for full suite.

### Test Writing Guidelines:

```python
# ‚úÖ GOOD - Tests behavior
def test_user_authentication_with_valid_credentials():
    response = api.login(username="user", password="pass")
    assert response.status_code == 200
    assert response.user_id is not None

# ‚ùå BAD - Tests implementation details
def test_user_authentication_calls_bcrypt_with_hash():
    with patch('bcrypt.checkpw') as mock_bcrypt:
        api.login(username="user", password="pass")
        mock_bcrypt.assert_called_once()
```

## üèóÔ∏è Architecture

- **Repository Pattern**: Use `apps/memory_api/repositories/` for DB access. Do NOT use raw SQL in services/routes.
- **Services**: Business logic goes in `apps/memory_api/services/`.
- **Routes**: FastAPI routes in `apps/memory_api/api/v1/` or `routes/`.
- **Config**: Use `apps/memory_api/config.py` via `pydantic-settings`. Do NOT hardcode secrets.

## üê≥ Docker

- If adding dependencies, update `requirements.txt` AND `Dockerfile` if needed.
- Ensure `docker-compose.yml` services are healthy after changes.

## üõ°Ô∏è Security

- Never expose API keys or secrets in code. Use `.env`.
- Ensure `TENANCY_ENABLED` logic is respected in new endpoints.

## üìö Documentation

- **Update Docs**: Before finishing a task or submitting a PR, run `make docs`.
- **Status**: Ensure `STATUS.md` and `TODO.md` are up-to-date with your changes.

## üìù Commit Messages (Conventional Commits)

Use [Conventional Commits](https://www.conventionalcommits.org/) format:

```bash
<type>: <description>

[optional body]
[optional footer]
```

**Types:**
- `feat:` - New feature (e.g., `feat: add GraphRAG entity resolution`)
- `fix:` - Bug fix (e.g., `fix: resolve authentication timeout`)
- `docs:` - Documentation only (e.g., `docs: update API cookbook`)
- `test:` - Adding/updating tests (e.g., `test: add hybrid search tests`)
- `refactor:` - Code change without behavior change (e.g., `refactor: simplify reflection engine`)
- `perf:` - Performance improvement (e.g., `perf: optimize vector similarity search`)
- `chore:` - Maintenance (dependencies, config) (e.g., `chore: update pytest to 8.0`)
- `ci:` - CI/CD changes (e.g., `ci: add security scanning job`)

**Examples:**
```bash
git commit -m "feat: add cost controller for LLM budget management"
git commit -m "fix: correct tenant isolation in memory queries"
git commit -m "docs: add architecture-to-code mapping document"
git commit -m "test: add integration tests for reflection engine"
```

## üöÄ Quick Reference

**Before Starting:**
1. Read `docs/BRANCHING.md` - Git workflow
2. Read `docs/AGENTS_TEST_POLICY.md` - Testing philosophy
3. Check `pytest.ini` - Test markers and coverage config

**Development Workflow:**
```bash
# 1. Create branch
git checkout develop && git pull
git checkout -b feature/my-feature

# 2. Code + Test (without coverage)
make test-focus FILE=apps/memory_api/tests/test_my_feature.py

# 3. Format + Lint
make format && make lint

# 4. Commit with conventional format
git commit -m "feat: add my feature"

# 5. Push and create PR
git push origin feature/my-feature

# 6. Verify CI is GREEN before merge to main
gh run watch
```

**When in Doubt:** Check existing code patterns and documentation - execute autonomously!
