# AI Agent Rules for RAE Project

## üö® Critical Rules - MUST FOLLOW

### 1. **NEVER use `nano` or interactive editors**

```bash
# ‚ùå FORBIDDEN - These will hang/block:
nano file.txt
vim file.txt
vi file.txt
emacs file.txt
less file.txt
more file.txt

# ‚úÖ ALLOWED - Use these instead:
cat file.txt           # View file
head -n 50 file.txt    # View first 50 lines
tail -n 50 file.txt    # View last 50 lines
grep "pattern" file.txt # Search in file

# ‚úÖ For editing, use dedicated tools:
# - Edit tool (old_string ‚Üí new_string)
# - Write tool (full file replacement)
# - sed for simple replacements
```

**Why?** Interactive commands require user input and block automation.

### 2. **NEVER use interactive git commands**

```bash
# ‚ùå FORBIDDEN:
git add -i
git rebase -i
git commit          # Opens editor!
git config --edit

# ‚úÖ ALLOWED:
git add .
git add file.txt
git commit -m "message"
git rebase origin/main
```

### 3. **Hybrid Testing Strategy**

The project uses a **smart hybrid CI workflow** to save tokens and time:

#### Quick Tests (Default on Feature Branches)
- **Automatically runs** on regular commits to `feature/*` branches
- Uses `pytest --testmon` to run **only affected tests**
- ~80% faster than full test suite
- Runs on Python 3.11 only

```bash
# Example: Regular feature branch commit
git commit -m "feat: add cache service"
# ‚Üí CI runs QUICK tests (only cache-related tests) ‚ö°
```

#### Full Tests (On-Demand or Automatic)
- **Automatically runs** on:
  - Pull Requests
  - Pushes to `main` or `develop`
  - Commits with `[full-test]` tag
- Runs **all 468 unit tests**
- Tests on Python 3.10, 3.11, 3.12
- **Catches regressions**

```bash
# Example: Ready for review
git commit -m "feat: add cache service [full-test]"
# ‚Üí CI runs FULL test suite (all tests, all Python versions) üîç
```

#### When to Use Each:

| Scenario | Use Quick | Use Full | How |
|----------|-----------|----------|-----|
| Adding new function | ‚úÖ | ‚ùå | Regular commit |
| Iterating on tests | ‚úÖ | ‚ùå | Regular commit |
| Bug fix (isolated) | ‚úÖ | ‚ùå | Regular commit |
| Ready for review | ‚ùå | ‚úÖ | Add `[full-test]` to commit |
| Before creating PR | ‚ùå | ‚úÖ | Add `[full-test]` to commit |
| Refactoring core code | ‚ùå | ‚úÖ | Add `[full-test]` to commit |
| Changed config/deps | ‚ùå | ‚úÖ | Add `[full-test]` to commit |

### 4. **Commit Message Format**

```
type(scope): short description

[optional detailed body]

[optional tags like [full-test]]
```

**Types**:
- `feat`: New feature
- `fix`: Bug fix
- `test`: Adding/updating tests
- `refactor`: Code refactoring
- `docs`: Documentation
- `ci`: CI/CD changes
- `perf`: Performance improvements
- `chore`: Maintenance tasks

**Examples**:
```bash
# Quick iteration
git commit -m "test: add unit tests for memory scoring"

# Ready for full validation
git commit -m "feat: implement hybrid search [full-test]"

# Bug fix with full validation
git commit -m "fix: null check in reflection pipeline [full-test]"
```

## üìã Workflow Examples

### Example 1: Adding New Feature (Token-Efficient)

```bash
# 1. Create feature branch
git checkout -b feature/add-caching

# 2. Implement + commit iteratively (quick tests each time)
git add apps/memory_api/services/cache_service.py
git commit -m "feat: add cache service skeleton"
# ‚Üí Quick tests run ‚ö° (30 seconds, ~10 tests)

git add apps/memory_api/tests/services/test_cache_service.py
git commit -m "test: add cache service tests"
# ‚Üí Quick tests run ‚ö° (45 seconds, ~15 tests)

# 3. Local testing
pytest apps/memory_api/tests/services/test_cache_service.py -v

# 4. Ready for review - full validation
git commit --allow-empty -m "feat: caching system complete [full-test]"
# ‚Üí Full tests run üîç (5 minutes, all 468 tests, 3 Python versions)

# 5. Create PR
gh pr create --title "Add Redis caching" --body "..."
# ‚Üí Full tests run again on PR üîç
```

**Token savings**: 5 quick test runs + 1 full = ~70% time/token savings vs 6 full runs

### Example 2: Fixing Bug (Fast Turnaround)

```bash
# 1. Fix + test locally
pytest apps/memory_api/tests/services/test_reflection.py -v

# 2. Commit with quick tests
git commit -m "fix: null check in reflection generation"
# ‚Üí Quick tests run ‚ö°

# 3. Verify no regressions - full test
git commit --allow-empty -m "fix: reflection null check [full-test]"
# ‚Üí Full tests run üîç

# 4. Merge if green
git checkout develop && git merge --no-ff fix/reflection-null-check
```

### Example 3: Coverage Improvement (Many Iterations)

```bash
# Working on feature/increase-test-coverage-to-80

# Iteration 1
git commit -m "test: add memory service CRUD tests"
# ‚Üí Quick tests ‚ö° (~20 new tests)

# Iteration 2
git commit -m "test: add reflection pipeline tests"
# ‚Üí Quick tests ‚ö° (~30 new tests)

# ... many iterations ...

# Iteration N (ready for review)
git commit -m "test: coverage increased to 65% [full-test]"
# ‚Üí Full tests üîç (verify no regressions)

# Create PR
gh pr create
# ‚Üí Full tests run again üîç
```

**Token savings**: 10+ quick runs + 2 full = ~85% time/token savings

## üéØ CI Behavior Matrix

| Branch | Event | Commit Message | Tests Run | Duration | Python Versions |
|--------|-------|----------------|-----------|----------|-----------------|
| `feature/*` | push | (regular) | Quick ‚ö° | ~1 min | 3.11 |
| `feature/*` | push | `[full-test]` | Full üîç | ~5 min | 3.10, 3.11, 3.12 |
| `feature/*` | PR | (any) | Full üîç | ~5 min | 3.10, 3.11, 3.12 |
| `main` | push | (any) | Full üîç | ~5 min | 3.10, 3.11, 3.12 |
| `develop` | push | (any) | Full üîç | ~5 min | 3.10, 3.11, 3.12 |
| (any) | push | (no .py files) | Skipped | ~30 sec | - |

## üõ†Ô∏è Development Commands

### Local Testing

```bash
# Quick feedback (only affected tests)
pytest --testmon

# Specific test file
pytest apps/memory_api/tests/services/test_memory.py -v

# Coverage for specific module
pytest --cov=apps/memory_api/services/memory_service \
       --cov-report=term-missing

# Full local test suite
pytest -m "not integration and not llm" --cov

# View detailed coverage report
pytest --cov --cov-report=html
firefox htmlcov/index.html
```

### Linting

```bash
# Run all linters
make lint

# Or individually
black apps/ sdk/ integrations/
isort apps/ sdk/ integrations/
ruff check apps/ sdk/ integrations/
```

### File Operations (Non-Interactive)

```bash
# ‚úÖ View files
cat file.txt
head -20 file.txt
tail -20 file.txt
grep "pattern" file.txt

# ‚úÖ Create files
cat > file.txt << 'EOF'
content here
EOF

# ‚úÖ Edit files (simple replacements)
sed -i 's/old/new/g' file.txt

# ‚úÖ Append to files
echo "new line" >> file.txt

# ‚ùå DON'T use interactive editors
nano file.txt   # FORBIDDEN!
vim file.txt    # FORBIDDEN!
```

## üêõ Common Issues

### Issue: "Coverage shows 2% instead of 48%"
**Cause**: Old problem - workflow was missing from feature branches
**Status**: ‚úÖ FIXED - All branches now have workflow
**Action**: None needed, this is resolved

### Issue: "Tests running too long / too many tokens"
**Solution**: Use quick tests during iteration, full tests only when ready:
```bash
# During iteration - quick tests
git commit -m "test: add more unit tests"

# When ready - full tests
git commit -m "test: coverage complete [full-test]"
```

### Issue: "Command hanging / no output"
**Cause**: Used interactive command (nano, vim, less, etc.)
**Solution**: Use non-interactive alternatives (cat, head, tail, grep)

### Issue: "Git commit opens editor"
**Cause**: Forgot `-m` flag
**Solution**: Always use `git commit -m "message"`, never just `git commit`

## üí° Best Practices

1. **Commit frequently** on feature branches (quick tests are fast!)
2. **Add `[full-test]` before PR** to catch regressions
3. **Run tests locally first** before pushing (saves CI time)
4. **Use descriptive commit messages** following the format
5. **Avoid interactive commands** in all scripts/workflows
6. **Check coverage locally** with `--cov-report=html` for detailed view

## üìä Coverage Targets

- **Current**: 48%
- **Target**: 80%
- **Priority**: Core services (memory, reflection, search, graph)

### Checking Coverage

```bash
# Project-wide
pytest --cov --cov-report=term-missing

# Specific module
pytest --cov=apps/memory_api/services/memory_service \
       --cov-report=term-missing

# HTML report (detailed)
pytest --cov --cov-report=html
firefox htmlcov/index.html
```

## Questions?

- Check `CONTRIBUTING.md` for more details
- Review existing tests in `apps/memory_api/tests/`
- Ask in project chat/issues

---

**Remember**: Quick tests save tokens, full tests catch regressions. Use both strategically! üéØ
