services:
  # The Kernel (Mock) - Lightweight HTTP server for connectivity tests
  rae-kernel:
    image: python:3.12-slim
    command: python3 /app/tests/hard_frames/mock_kernel.py
    networks:
      - rae_internal
      - public_net
    volumes:
      - .:/app # Mount project root to access the script
    working_dir: /app

  # The Agent - NO internet access
  rae-agent-secure:
    build:
      context: .
      dockerfile: Dockerfile.agent_secure
    networks:
      - rae_internal
    depends_on:
      - rae-kernel
    environment:
      - RAE_KERNEL_URL=http://rae-kernel:8000
    command: ["python", "-m", "rae_agent.main", "--soak-test"]

  # Real Memory Retrieval Test
  rae-agent-recall:
    build:
      context: .
      dockerfile: Dockerfile.agent_secure
    networks:
      - rae_network_external
    environment:
      - RAE_KERNEL_URL=http://rae-api-dev:8000
      - RAE_AGENT_MODE=secure
      - PYTHONPATH=/app
    command: ["python", "/app/tests/hard_frames/recall_check.py"]

networks:
  rae_internal:
    internal: true # CRITICAL: No external access
    driver: bridge
  public_net:
    driver: bridge
  rae_network_external:
    external: true
    name: rae-node-agent_rae-network
