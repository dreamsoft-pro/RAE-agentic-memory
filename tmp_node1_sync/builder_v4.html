{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link href="{% static 'css/gridstack.min.css' %}" rel="stylesheet"/>
<style>
    .grid-stack { background: #f8f9fa; border: 1px dashed #ced4da; min-height: 80vh; }
    .grid-stack-item-content { background: white; border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .widget-header { background: #f1f3f5; padding: 8px 12px; font-size: 0.9rem; font-weight: bold; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
    .widget-body { padding: 10px; height: calc(100% - 40px); width: 100%; }
    .chart-container { width: 100%; height: 100%; min-height: 200px; }
    .btn-group-sm > .btn { margin-right: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>ScreenWatcher Dashboard <small class="text-muted">v4 Professional</small></h2>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="addNewWidget('status_card', 'Machine Status')">+ Status</button>
            <button class="btn btn-outline-primary" onclick="addNewWidget('oee_gauge', 'Real-time OEE')">+ OEE Gauge</button>
            <button class="btn btn-outline-primary" onclick="addNewWidget('reliability_card', 'Reliability Metrics')">+ Reliability</button>
            <button class="btn btn-primary ms-3" onclick="location.reload()">Refresh Data</button>
        </div>
    </div>
    <div class="grid-stack"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/gridstack.all.js' %}"></script>
<script src="{% static 'js/echarts.min.js' %}"></script>

<script>
    let grid;
    const charts = {};
    const DEFAULT_MACHINE_ID = '6eb33c58-7a60-4f9c-b9fb-d0b626410459'; // Your TM01 Machine

    document.addEventListener("DOMContentLoaded", function() {
        grid = GridStack.init({ cellHeight: 70, float: true, removable: true });
        
        // Load existing widgets from DB
        const widgetsDB = {{ widgets_json|safe|default:"[]" }};
        widgetsDB.forEach(w => renderWidget(w));

        // Global resize handler
        window.addEventListener('resize', () => {
            Object.values(charts).forEach(c => c.resize());
        });
    });

    function addNewWidget(type, title) {
        const id = 'new-' + Math.random().toString(36).substr(2, 9);
        const w = {
            id: id,
            widget_type: type,
            title: title,
            pos_x: 0, pos_y: 0, width: 4, height: 4,
            config: { machine_id: DEFAULT_MACHINE_ID }
        };
        renderWidget(w);
    }

    function renderWidget(w) {
        let content = `
            <div class="grid-stack-item-content">
                <div class="widget-header">
                    <span>${w.title}</span>
                    <button class="btn btn-xs btn-link text-danger" onclick="grid.removeWidget(this.parentElement.parentElement.parentElement)">Ã—</button>
                </div>
                <div class="widget-body">
                    <div id="chart-${w.id}" class="chart-container"></div>
                </div>
            </div>`;
        
        grid.addWidget({x: w.pos_x, y: w.pos_y, w: w.width, h: w.height, content: content, id: w.id});
        
        setTimeout(() => initChart(w), 500);
    }

    function initChart(w) {
        const dom = document.getElementById('chart-' + w.id);
        if (!dom) return;

        const myChart = echarts.init(dom);
        charts[w.id] = myChart;
        myChart.showLoading();

        const machineId = w.config.machine_id || DEFAULT_MACHINE_ID;

        fetch('/dashboard/stats/' + machineId + '/')
            .then(r => r.json())
            .then(data => {
                myChart.hideLoading();
                let option = {};

                if (w.widget_type === 'oee_gauge') {
                    let val = data.oee ? Math.round(data.oee.oee) : 0;
                    option = {
                        series: [{
                            type: 'gauge',
                            progress: { show: true, width: 12 },
                            axisLine: { lineStyle: { width: 12 } },
                            detail: { valueAnimation: true, formatter: '{value}%', fontSize: 22 },
                            data: [{ value: val, name: 'OEE' }]
                        }]
                    };
                } 
                else if (w.widget_type === 'status_card') {
                    const status = data.machine.status;
                    const color = status === 'RUNNING' ? '#28a745' : (status === 'IDLE' ? '#ffc107' : '#dc3545');
                    option = {
                        graphic: {
                            elements: [{
                                type: 'text', left: 'center', top: 'center',
                                style: { text: status, fontSize: 32, fontWeight: 'bold', fill: color }
                            }]
                        }
                    };
                }
                else if (w.widget_type === 'reliability_card') {
                    option = {
                        xAxis: { type: 'category', data: ['Availability', 'Performance', 'Quality'] },
                        yAxis: { type: 'value', max: 100 },
                        series: [{
                            data: [
                                Math.round(data.oee.availability), 
                                Math.round(data.oee.performance), 
                                Math.round(data.oee.quality)
                            ],
                            type: 'bar',
                            itemStyle: { color: '#5470c6' }
                        }]
                    };
                }

                myChart.setOption(option);
            })
            .catch(err => {
                myChart.hideLoading();
                dom.innerHTML = "<div class='text-danger p-2'>Error loading data</div>";
            });
    }
</script>
{% endblock %}
