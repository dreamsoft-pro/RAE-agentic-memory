{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<link href="{% static 'css/gridstack.min.css' %}" rel="stylesheet"/>
<style>
    .grid-stack { background: #f8f9fa; border: 1px dashed #ced4da; min-height: 80vh; }
    .grid-stack-item-content { background: white; border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .widget-header { background: #f1f3f5; padding: 5px 10px; font-size: 0.85rem; border-bottom: 1px solid #dee2e6; cursor: move; display: flex; justify-content: space-between; align-items: center; }
    .widget-body { padding: 10px; height: calc(100% - 35px); width: 100%; }
    .chart-container { width: 100%; height: 100%; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Dashboard Builder</h2>
        <div>
            <button class="btn btn-primary btn-sm ms-3" onclick="location.reload()">Refresh Data</button>
        </div>
    </div>

    <div class="grid-stack"></div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/gridstack.all.js' %}"></script>
<script src="{% static 'js/echarts.min.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof GridStack === 'undefined') {
            alert("Error: GridStack failed to load locally!");
            return;
        }

        let grid = GridStack.init({ cellHeight: 70, acceptWidgets: true, removable: '#trash', float: true });
        window.grid = grid;
        let charts = {}; 

        const widgetsDB = {{ widgets_json|safe|default:"[]" }};
        widgetsDB.forEach(w => {
            addWidgetFromDB(w);
        });

        function addWidgetFromDB(w) {
            let content = `
                <div class="grid-stack-item-content">
                    <div class="widget-header">
                        <span class="widget-title">${w.title || w.widget_type.toUpperCase()}</span>
                    </div>
                    <div class="widget-body">
                        <div id="chart-${w.id}" class="chart-container" style="display:flex; justify-content:center; align-items:center;">Loading...</div>
                    </div>
                </div>`;
            
            grid.addWidget({x: w.pos_x, y: w.pos_y, w: w.width, h: w.height, content: content, id: w.id});
            setTimeout(() => initChart(w.id, w.widget_type, w.config), 100);
        }

        function initChart(id, type, config) {
            let chartDom = document.getElementById('chart-' + id);
            if (!chartDom) return;
            
            // Clear text
            chartDom.innerHTML = "";
            chartDom.removeAttribute("style"); // Remove flex centering for echarts

            let myChart = echarts.init(chartDom);
            myChart.showLoading();

            const machineId = config.machine_id;
            if (!machineId) {
                chartDom.innerHTML = "Config Error: No machine_id";
                return;
            }

            fetch(`/dashboard/stats/${machineId}/`)
            .then(r => {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            })
            .then(data => {
                myChart.hideLoading();
                
                let option = {};
                
                if (type === 'status_card') {
                    const status = data.machine ? data.machine.status : 'UNKNOWN';
                    const color = status === 'RUNNING' ? '#28a745' : (status === 'IDLE' ? '#ffc107' : '#dc3545');
                    option = {
                        graphic: {
                            elements: [
                                {
                                    type: 'text',
                                    left: 'center',
                                    top: 'center',
                                    style: {
                                        text: status,
                                        fontSize: 40,
                                        fontWeight: 'bold',
                                        fill: color
                                    }
                                }
                            ]
                        }
                    };
                } else if (type === 'oee_gauge') {
                    let val = data.oee ? Math.round(data.oee.oee) : 0;
                    option = {
                        series: [
                            {
                                type: 'gauge',
                                progress: { show: true, width: 18 },
                                axisLine: { lineStyle: { width: 18 } },
                                axisTick: { show: false },
                                splitLine: { length: 15, lineStyle: { width: 2, color: '#999' } },
                                axisLabel: { distance: 25, color: '#999', fontSize: 14 },
                                anchor: { show: true, showAbove: true, size: 25, itemStyle: { borderWidth: 10 } },
                                title: { show: false },
                                detail: {
                                    valueAnimation: true,
                                    fontSize: 40,
                                    offsetCenter: [0, '70%']
                                },
                                data: [{ value: val }]
                            }
                        ]
                    };
                } else if (type === 'reliability_card') {
                     option = {
                        tooltip: {},
                        xAxis: { type: 'category', data: ['MTBF', 'MTTR', 'Scrap'] },
                        yAxis: { type: 'value' },
                        series: [{
                            data: [120, 15, 2.5], // Fake data if API missing fields
                            type: 'bar',
                            itemStyle: { color: '#5470c6' }
                        }]
                    };
                } else {
                    chartDom.innerHTML = "Unknown chart type: " + type;
                    myChart.dispose();
                    return;
                }

                myChart.setOption(option);
            })
            .catch(err => {
                myChart.dispose();
                chartDom.innerHTML = "<div style='color:red; padding:10px;'>Fetch Error: " + err.message + "</div>";
            });
        }
    });
</script>
{% endblock %}
