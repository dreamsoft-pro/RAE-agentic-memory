{{- if not .Values.externalSecrets.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "rae-memory.fullname" . }}-secrets
  labels:
    {{- include "rae-memory.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Database credentials
  database-url: {{ .Values.postgresql.auth.connectionString | default (printf "postgresql://%s:%s@%s-postgresql:5432/%s" .Values.postgresql.auth.username .Values.postgresql.auth.password (include "rae-memory.fullname" .) .Values.postgresql.auth.database) | quote }}

  # Redis credentials
  redis-url: {{ .Values.redis.auth.connectionString | default (printf "redis://:%s@%s-redis-master:6379/0" .Values.redis.auth.password (include "rae-memory.fullname" .)) | quote }}

  # LLM API Keys
  openai-api-key: {{ .Values.secrets.openaiApiKey | default "" | quote }}
  anthropic-api-key: {{ .Values.secrets.anthropicApiKey | default "" | quote }}
  gemini-api-key: {{ .Values.secrets.geminiApiKey | default "" | quote }}

  # JWT Secret for authentication
  jwt-secret: {{ .Values.secrets.jwtSecret | default (randAlphaNum 32) | quote }}

  # API Keys for external integrations
  api-master-key: {{ .Values.secrets.apiMasterKey | default (randAlphaNum 64) | quote }}
{{- end }}
---
{{- if .Values.externalSecrets.enabled }}
# External Secrets Operator integration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "rae-memory.fullname" . }}-secrets
  labels:
    {{- include "rae-memory.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStore }}
    kind: {{ .Values.externalSecrets.secretStoreKind | default "SecretStore" }}
  target:
    name: {{ include "rae-memory.fullname" . }}-secrets
    creationPolicy: Owner
  data:
  - secretKey: database-url
    remoteRef:
      key: {{ .Values.externalSecrets.keys.databaseUrl }}
  - secretKey: redis-url
    remoteRef:
      key: {{ .Values.externalSecrets.keys.redisUrl }}
  - secretKey: openai-api-key
    remoteRef:
      key: {{ .Values.externalSecrets.keys.openaiApiKey }}
  - secretKey: anthropic-api-key
    remoteRef:
      key: {{ .Values.externalSecrets.keys.anthropicApiKey }}
  - secretKey: gemini-api-key
    remoteRef:
      key: {{ .Values.externalSecrets.keys.geminiApiKey }}
  - secretKey: jwt-secret
    remoteRef:
      key: {{ .Values.externalSecrets.keys.jwtSecret }}
  - secretKey: api-master-key
    remoteRef:
      key: {{ .Values.externalSecrets.keys.apiMasterKey }}
{{- end }}
